{{!-- Title Tag SEO --}}

<head>
    <title>https://happyminds.onrender.com/</title>
</head>
{{!-- Title Meta description Tag--}}

<head>
    <meta name="description" content="
    {{!-- Content of desciption --}}
    Trang Web tập thể dục chất lượng cao, 
    nơi bạn có thể truy cập miễn phí và tận hưởng những buổi tập đa dạng, 
    giúp nâng cao sức khỏe và tinh thần của bạn!.
">
</head>
<header>
    <a href="https://happyminds.onrender.com/" style="display: none;"></a>
</header>
<link rel="canonical" href="https://happyminds.onrender.com/">
<div class="container bg-white">
    <div class="d-flex flex-row gap-5 d-flex align-items-center md-5">
        <h4 class="fs-4 text-primary col-lg-3 col-md-3 mb-0">March 22,
            2023</h4>
        <div class=" col-lg-8 col-md-8 d-flex justify-content-end">
            <img class="col-lg-4 col-1 mt-4 my-2" style="width: 48px; height: 45px" src="/img/Image.png" alt>
            <p class="fs-5 m-0 d-flex align-items-center mt-4 mx-2">Benjamin Gray</p>
        </div>
    </div>

    <div class="row">
        <div class=" col-lg-8 col-8 mb-2">
            <h2 class="text-lg-start fw-bold">{{blog.title}}</h2>
        </div>
    </div>
    <img class="col-lg-12m col-12 mb-lg-12 rounded-2 " src="{{blog.image}}" alt>

    <!-- body -->
    <center>
        <p class="col-lg-10 col-md-12 mt-3">{{blog.content}}</p>
        <hr style="height: 10px;width:70%" class="mt-5 ">
    </center>

    <div class="d-flex justify-content-between align-items-around">
        <div></div>
        <div></div>
        <button class="btn-outline-danger btn d-flex align-items-center" id="likeBlogBtn"
            onclick=handleLikeBtn({{isLogin}},"{{blog._id }}")>
            <i class="bi bi-heart" id="like"></i>
            <i class="bi bi-heart-fill" id="liked" style="display: none;"></i>
            <p class="m-0 ms-1"><b>Like</b></p>
        </button>
        <button class="btn btn-outline-secondary d-flex align-items-center " id="commentBtn">
            <i class="bi bi-chat-dots"></i>
            <label class="ms-1 m-0" for="commentInp"><b>Comment</b></label>
        </button>

        <button class="btn btn-outline-primary d-flex align-items-center" data-bs-toggle="modal"
            data-bs-target="#exampleModal">
            <i class="bi bi-share me-1"></i>
            <p class="m-0"><b>Share</b>
        </button>
        <div></div>
        <div></div>
    </div>
    {{!-- Comment --}}
    <div class="row d-flex justify-content-center pb-4">
        <div class="card mt-4 col-9 pb-1 mb-4">
            <div class="card-body ">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <img class="rounded-circle"
                            src="https://i.pinimg.com/236x/38/a5/1f/38a51fbad2946fd87525c807d2a078e4.jpg"
                            alt="Profile Picture" style="width: 30px; height: 30px;">
                    </div>
                    <div class="col p-0">
                        <h6 class="mb-0 p-0">You</h6>
                    </div>
                    <div class="col-10"></div>
                    <div class="col-auto pe-2" onclick=cancelComment("commentInp")>
                        <button class="btn btn-outline-danger">
                            <i class="bi bi-x-circle-fill"></i>
                        </button>
                    </div>
                </div>
                <form id="commentForm" class="row mt-3 commentForm">
                    <div class="col-10 pe-2">
                        <input type="text" class="form-control" name="content" id="commentInp"
                            placeholder="Nhập bình luận của bạn . . .">
                        <input type="hidden" id="hiddenInput" name="blogId" value="{{blog._id}}">
                    </div>

                    <div class="col d-flex align-items-center">
                        <div class="row justify-content-between">
                            <label class="col px-4 btn btn-outline-secondary">
                                <i class="bi bi-upload"></i>
                                <input type="file" class="custom-file-input" name="imgUrl" id="fileInput"
                                    style="display: none;">
                            </label>
                            <button class="col px-4 btn btn-primary ms-2"
                                onclick=submitComment({{isLogin}},"commentForm")>
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {{!-- commet list --}}
    <div class="row d-flex justify-content-center pb-4" id="commentList"></div>
    {{!-- Model Share post --}}
    <div class="modal fade " id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content col-md-10" style="border-radius: 20px 20px 20px 20px;">
                <div class="modal-header d-flex justify-content-center"
                    style="background-color:rgba(253, 0, 84, 1); border-radius: 20px 20px 0 0;">
                    <h5 class="modal-title text-white" id="exampleModalLabel">Click To Copy</h5>

                </div>
                <div class="modal-body ">
                    <input class="form-control" name="" id="linkPost" style="border-radius:10px;text-align: center;"
                        readonly placeholder="" onclick="sharePost()">
                </div>
                <div class="modal-footer d-flex justify-content-center border" style="border-radius: 0 0 20px 20px;">
                    <button type="button" class="btn btn-secondary" style="width: 200px;" data-bs-dismiss="modal"
                        aria-label="Close">Cancel</button>
                    <button type="button" class="btn btn-danger " style="width: 200px;"
                        onclick="sharePost()">Copy</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var blogId = {{{ json blog._id }}};
    var likedList = {{{ json blog.likedList }}};
    checkUserLiked({{ isLogin }}, likedList);
    async function checkUserLiked(isLogin, likedList) {
        if (isLogin) {
            try {
                var response = await axios.get('http://localhost:3000/user/getUserByEmail');
                var user = response.data;
                if (likedList.includes(user._id)) {
                    var likeBtn = document.querySelector('#likeBlogBtn');
                    likeBtn.classList.toggle('redColor');
                    likeBtn.classList.toggle('whiteColor');
                }
            } catch (error) {
                console.error('Lỗi khi kiểm tra người dùng đã thích:', error);
            }
        }
    }
    renderComments(`${blogId}`);

    async function handleLikeBtn(isLogin, blogId) {
        if (!isLogin) {
            $('#login_form').modal('show');
        } else {
            var user = await axios.get(`http://localhost:3000/user/getUserByEmail`);
            console.log(user);
            var likeBtn = document.querySelector('#likeBlogBtn');
            likeBtn.classList.toggle('redColor');
            likeBtn.classList.toggle('whiteColor');
            if (likeBtn.classList.contains('redColor')) {
                try {
                    data = await axios.patch(`http://localhost:3000/blog/addLike?blogId=${blogId}&userId=${user.data._id}`);
                } catch (err) {
                    console.log(err);
                }
            } else {
                try {
                    data = await axios.patch(`http://localhost:3000/blog/removeLike?blogId=${blogId}&userId=${user.data._id}`);
                } catch (err) {
                    console.log(err);
                }
            }
        }
    }


    document.addEventListener('click', function (event) {
        // Kiểm tra xem phần tử đã click có class là 'replycommentParent' không
        if (event.target.closest('.replyCommentParent')) {
            var replyCommentParent = event.target.closest('.replyCommentParent');
            var commentId = replyCommentParent.querySelector('.replyCommentInp').id;
            var replyComments = document.querySelectorAll('.replyCommentInp');
            replyComments.forEach(e => {
                if (e.id != commentId) e.innerHTML = ''
            });
        }
    });

    async function submitComment(isLogin, formId) {
        event.preventDefault();
        if (!isLogin) {
            $('#login_form').modal('show');
        } else {
            var user = await axios.get(`http://localhost:3000/user/getUserByEmail`);
            var form = $(`#${formId}`)[0];
            var formData = new FormData(form);
            formData.append('userId', user.data._id)
            await axios.post('http://localhost:3000/comment/', formData,)
            $('#commentInp')[0].value = '';
            if (formId == "commentForm") renderComments(`${blogId}`)
            else renderReplyComments(form.parentId.value);
        }
    }

    async function renderReplyComments(parentId) {
        try {
            var data = await axios.get(`http://localhost:3000/comment/getReplyComments?parentId=${parentId}`);
            var comments = data.data;
            var promises = comments.map(async (comment) => {
                var user = await axios.get(`http://localhost:3000/user/getById?id=${comment.userId}`);
                var userName = user.data.name == "CastError" ? "Người dùng HappyMinds" : user.data.name;
                return `
                    <div class="d-flex justify-content-start card mt-4 col-11 pb-1 mb-4">
                        <div class="card-body ">
                            <div class="row justify-content-start">
                                <div class="col-auto">
                                    <img class="rounded-circle"
                                        src="https://i.pinimg.com/236x/38/a5/1f/38a51fbad2946fd87525c807d2a078e4.jpg"
                                        alt="Profile Picture" style="width: 30px; height: 30px;">
                                </div>
                                <div class="col p-0">
                                    <h6 class="mb-0 p-0" id="name">${userName}</h6>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-10 pe-2">
                                    <div>${comment.content}</div>
                                    <div id="img${comment._id}">
                                        <img class="col-lg-12m col-12 mb-lg-12 rounded-2 " src="${comment.imgUrl}" style="width: 200px">
                                    </div>
                                </div>
                                <div class="col d-flex align-items-center justify-content-between"> 
                                    <div class="row justify-content-between">
                                        <label class="px-4 col btn btn-outline-danger" id="iconHeart">
                                            <i class="bi bi-heart"></i>
                                        </label>
                                        <button class="px-4 ms-2 col btn btn-primary" onclick=showReplyCommentInp("${comment.parentId}")>
                                            <i class="bi bi-arrow-return-left"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                `;
            });
            var contents = await Promise.all(promises);
            var content = contents.join('');
            $(`#replyCommentList${parentId}`)[0].innerHTML = content;
            $(`#replyCommentList${parentId}`)[0].innerHTML += `
                <div class="col-12 replyCommentInp" id="${parentId}" ></div>`;
        } catch (err) {
            console.error(err);
        }
    }

    async function renderComments(blogId) {
        try {
            var data = await axios.get(`http://localhost:3000/comment/getBlogComments?blogId=${blogId}`);
            var comments = data.data;
            var promises = comments.map(async (comment) => {
                var user = await axios.get(`http://localhost:3000/user/getById?id=${comment.userId}`);
                var userName = user.data.name == "CastError" ? "Người dùng HappyMinds" : user.data.name;
                let responseText = comment.responseTimes ? `Hiển thị thêm ${comment.responseTimes} lượt phản hồi` : '';
                return `
                <div class="card mt-4 col-9 pb-1 mb-4 replyCommentParent" style="position: relative;">
                    <div class="card-body ">
                        <div class="row justify-content-start">
                            <div class="col-auto">
                                <img class="rounded-circle"
                                    src="https://i.pinimg.com/236x/38/a5/1f/38a51fbad2946fd87525c807d2a078e4.jpg"
                                    alt="Profile Picture" style="width: 30px; height: 30px;">
                            </div>
                            <div class="col p-0">
                                <h6 class="mb-0 p-0" id="name">${userName}</h6>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-10 pe-2">
                                <div>${comment.content}</div>
                                <div id="img${comment._id}">
                                    <img class="col-lg-12m col-12 mb-lg-12 rounded-2 " src="${comment.imgUrl}" style="width: 200px">
                                </div>
                            </div>
                            <div class="col d-flex align-items-center justify-content-between"> 
                                <div class="row justify-content-between">
                                    <label class="px-4 col btn btn-outline-danger" id="iconHeart">
                                        <i class="bi bi-heart"></i>
                                    </label>
                                    <button class="px-4 ms-2 col btn btn-primary" onclick=showReplyCommentInp("${comment._id}")>
                                        <i class="bi bi-arrow-return-left"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="position:relative;left:40px;" id="replyCommentList${comment._id}">
                        <b onmouseover="this.style.cursor='pointer'" onmouseout="this.style.cursor='default'" onclick=renderReplyComments("${comment._id}")>${responseText}</b>
                        <div class="col-12 replyCommentInp" id="${comment._id}" ></div>
                    </div>
                </div>
            `;
            });
            var contents = await Promise.all(promises);
            var content = contents.join('');
            $("#commentList")[0].innerHTML = content;
        } catch (error) {
            console.error(error);
        }
    }

    function showReplyCommentInp(commentId) {
        document.getElementById(commentId).innerHTML = `
            <div class="d-flex justify-content-start card mt-4 col-11 pb-1 mb-4">
                <div class="card-body ">
                    <div class="row justify-content-start">
                        <div class="col-auto">
                            <img class="rounded-circle"
                                src="https://i.pinimg.com/236x/38/a5/1f/38a51fbad2946fd87525c807d2a078e4.jpg"
                                alt="Profile Picture" style="width: 30px; height: 30px;">
                        </div>
                        <div class="col p-0">
                            <h6 class="mb-0 p-0" id="name">You</h6>
                        </div>
                        <div class="col-auto pe-2" onclick=cancelComment("replyCommentInp")>
                            <button class="btn btn-outline-danger">
                                <i class="bi bi-x-circle-fill"></i>
                            </button>
                        </div>
                    </div>
                    <form id="replyCommentForm" class="row mt-3">
                        <div class="col-10 pe-2">
                            <input type="text" class="form-control" name="content" id="replyCommentInp"
                                placeholder="Type your review comment . . .">
                            <input type="hidden" id="hiddenInput" name="parentId" value="${commentId}">
                        </div>
                        <label class="col btn btn-outline-secondary pe-2">
                            <i class="bi bi-upload"></i>
                            <input type="file" class="custom-file-input" name="upload" id="fileInput"
                                style="display: none;">
                        </label>
                        <button class="col btn btn-primary ms-2 me-2" onclick=submitComment({{isLogin}},"replyCommentForm")> 
                            <i class="bi bi-send"></i>
                        </button>
                    </form>
                </div>
            </div>
        `;
        $('#replyCommentInp')[0].focus();
    }

    setTimeout(function () {
        var link = window.location.href;
        document.getElementById('linkPost').value = link; // Set value of 'linkPost' to the current URL
    }, 200);

    function sharePost() {
        document.getElementById('linkPost').value = "Coppied!"; // Set value of 'linkPost' to the current URL
        var linkToCopy = window.location.href; // Link to share with the user
        var textarea = document.createElement("textarea");
        textarea.value = linkToCopy;
        document.body.appendChild(textarea);
        textarea.select();
        try {
            navigator.clipboard.writeText(textarea.value);
        } catch (err) {
            console.error("Unable to copy", err);
        }
        document.body.removeChild(textarea);
    }

    function cancelComment(id) {
        document.getElementById(`${id}`).value = '';
    }

</script>